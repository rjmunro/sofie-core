name: Auto-approve uncontested PRs after 7 days

on:
  schedule:
    - cron: '26 5 * * *' # Run every day at 5:26 AM UTC (time chosen randomly to avoid creating peaks)
  workflow_dispatch: # Allow manual triggering

permissions:
  pull-requests: write

jobs:
  approve-uncontested-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-approve uncontested PRs
        uses: actions/github-script@v7
        with:
          script: |
            // Calculate the date 7 days ago
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            // Fetch all open pull requests, sorted by last update (oldest first)
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'asc'
            });
            
            for (const pr of pullRequests) {
              // Skip draft PRs
              if (pr.draft) {
                console.log(`Skipping PR #${pr.number}: Draft PR`);
                continue;
              }
              
              // Use updated_at instead of created_at to ensure we don't auto-approve
              // code that was just pushed to an old PR
              const lastActivity = new Date(pr.updated_at);
              
              // Only process PRs that haven't been updated in 7+ days
              if (lastActivity < sevenDaysAgo) {
                // Fetch reviews to check for objections and prior bot approval
                const { data: reviews } = await github.rest.pulls.listReviews({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_request_number: pr.number
                });
                
                // Check if any reviewer has requested changes
                const hasChangesRequested = reviews.some(
                  review => review.state === 'CHANGES_REQUESTED'
                );
                
                if (hasChangesRequested) {
                  console.log(`Skipping PR #${pr.number}: Has changes requested`);
                  continue;
                }
                
                // Check if already approved by this action to avoid spamming
                const alreadyApproved = reviews.some(
                  review => review.user.login === 'github-actions[bot]' && review.state === 'APPROVED'
                );
                
                if (!alreadyApproved) {
                  // Submit an approval review
                  await github.rest.pulls.createReview({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_request_number: pr.number,
                    body: 'âœ… Auto-approving: This PR has been inactive for 7+ days with no objections.',
                    event: 'APPROVE'
                  });
                  
                  console.log(`Approved PR #${pr.number}: ${pr.title}`);
                }
              }
            }
